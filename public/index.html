<!DOCTYPE html>
<html>
<head>
	<title>Nissepedia artiklar</title>
</head>
<body>

	

	<style type="text/css">
	.item
	{

	}

	.buttons
	{
		display: inline-block;
	}

	.button
	{
		
	}

	.label
	{
		width: 15px;
	}

	.namefield
	{
		display: inline-block;
	}

	.coloryes
	{
		display: inline-block;
		color: #139B00;
	}
	
	.colorno
	{
		display: inline-block;
		color: #D50000;
	}

	.colorundecided{
		display: inline-block;
		color: #AAAAAA;	
	}

	.listcontainer
	{
		width: 20%;
	}

	.iframe
	{
		right: 0em;
		position: fixed;
		top: 0em;
		height: 100%;
		width: 80%;
	}

	</style>

	<input id='loginbutton' type='button' value='Login'></input>
	<input id='user' value='' placeholder='user'></input>
	<input id='pass' value='' placeholder='pass'></input>

	<div id="listcontainer" class="listcontainer">
	</div>

	<iframe src="http://www.nissepedia.com" name="articleframe" class="iframe"></iframe>

	<script type="text/javascript">

		var users = ['pot', 'jpn', 'hk', 'tb'];


		var listContainer = document.getElementById('listcontainer');


		function getInclusionClass(respObj, user)
		{
			if('include_' + user in respObj && respObj['include_' + user] === 'Y')
			{
				return 'coloryes';	
			}
			else if ('include_' + user in respObj && respObj['include_' + user] === 'N')
			{
				return 'colorno';	
			}else
			{
				return 'colorundecided';
			}
		}

		function setInclusion(name, value, buttons)
		{
			var user = getUser();
			var pass = getPass();

			var request = new XMLHttpRequest();

			request.onload = function(result)
			{
				var array = JSON.parse(request.responseText);
				// reload the item
				loadItem(name, buttons);
			}
			request.onError = function(err)
			{
				console.error('error: ' + err);
			}

			request.open("get", "../setinclude?user=" + user + "&pass=" + pass + "&name=" + name + "&value=" + value, true);
			request.send();
		}

		function loadItem(name, buttons)
		{
			var itemRequest = new XMLHttpRequest();

			
			
			itemRequest.onload = function()
			{

				var resp = itemRequest.responseText;
				var respObj = JSON.parse(resp);

				// clear buttons
				while (buttons.firstChild) {
    				buttons.removeChild(buttons.firstChild);
				}
			
				for (var i= 0; i < users.length; i++)
				{
					var user = users[i];
					var okButton;
					var noButton;
					var otherLabel;

					if (getUser() === user)
					{
						okButton = document.createElement('input');
						okButton.type = 'button';
						okButton.value = '✔';

						okButton.onclick = function(){setInclusion(name, 'Y', buttons)};

						noButton = document.createElement('input');
						noButton.type = 'button';
						noButton.value = '✘';

						noButton.onclick = function(){setInclusion(name, 'N', buttons)};

						
						okButton.classList.add(getInclusionClass(respObj, user));
						noButton.classList.add(getInclusionClass(respObj, user));

						okButton.classList.add('button');
						noButton.classList.add('button');
						
						
					}else
					{
						otherLabel = document.createElement('div');

						if ('include_' + user in respObj && respObj['include_' + user] === 'Y')
						{	
							otherLabel.innerHTML = '✔';
						}
						else if('include_' + user in respObj && respObj['include_' + user] === 'N')
						{
							otherLabel.innerHTML = '✘';
						}
						else
						{
							otherLabel.innerHTML = '♦';
						}

						otherLabel.title = user;

						otherLabel.classList.add(getInclusionClass(respObj, user));
						otherLabel.classList.add('label');
						
					}

					if(okButton) buttons.insertBefore(okButton, buttons.firstChild);
					if(noButton) buttons.insertBefore(noButton, buttons.firstChild);
					if(otherLabel) buttons.appendChild(otherLabel);
				}

			};



			itemRequest.open("get", "../get?name=" + name + "&user=" + getUser() + "&pass=" + getPass(), true);
			itemRequest.send();
		}

		function addItem (name)
		{
			var item = document.createElement('div');
			item.classList.add('item');

			var buttons = document.createElement('div');
			buttons.classList.add('buttons');

			item.appendChild(buttons);

			var nameField = document.createElement('div');
			nameField.classList.add('namefield');
			nameField.innerHTML = '<a href="http://nissepedia.com/index.php?title=' +encodeURIComponent(name)+ '" target="articleframe">' + name + '</a>';
			item.appendChild(nameField);

			listContainer.appendChild(item);

			loadItem(name, buttons);
		}

		function loginAndList()
		{

			var user = getUser();
			var pass = getPass();

			var request = new XMLHttpRequest();

			request.onload = function(result)
			{

				// clear buttons
				while (listcontainer.firstChild) {
    				listcontainer.removeChild(listcontainer.firstChild);
				}

				console.log('got: ' + request.responseText);

				var array = JSON.parse(request.responseText);

				for (var i = 0; i < array.length; i++) {
					addItem(array[i]);
				}
			}
			request.onError = function(err)
			{
				console.error('error: ' + err);
			}

			request.open("get", "../list?user=" + user + "&pass=" + pass, true);
			request.send();
		}

		function getUser()
		{
			return document.getElementById('user').value;
		}

		function getPass()
		{
			return document.getElementById('pass').value;
		}

		document.getElementById('loginbutton').onclick = function() { loginAndList() };


	</script>

</body>
</html>